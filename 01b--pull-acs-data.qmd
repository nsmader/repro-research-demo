---
title: "Untitled"
format: html
editor: source
---

```{r}
#| label: pull ACS data

# Metadata for American Community Survey Poverty table (among multiple options): 
#   https://pearson.socialexplorer.com/data/ACS2022/metadata/?ds=ACS22&table=B16004
ma_pov <- 
  get_acs( 
    geography = "tract", 
    variables = c("B16004_001", "B16004_002"),
    state = "MA", 
    year = 2022,
    geometry = TRUE,
    output = "wide",
  ) %>% 
  rename(all_n = B16004_001E,
         pov_n = B16004_002E) %>% 
  select(GEOID, all_n, pov_n)

```

```{r}
#| label: source and compare school district geographies to district names in teacher data

# Pull Massachusetts school district geographies from the Census TIGER service
ma_sds <- tigris::school_districts(state = "MA", cb = TRUE)

# Load teacher data
load("data/ma_ed.Rda")

# Compare school districts in shape file to teacher data
cbind(ma_sds$NAME      %>% sort() %>% head(20), 
      ma_ed$distr_name %>% sort() %>% unique() %>% head(20))
```

```{r}
#| label: iteratively clean and compare district names

ma_sds <- 
  ma_sds %>% 
  mutate(distr_name_forcomp = 
           NAME %>% 
           str_replace("(Regional)? School District", "") %>% 
           str_trim() %>% 
           str_to_lower())

ma_ed <- 
  ma_ed %>% 
  mutate(distr_name_forcomp =
           distr_name %>% 
           str_replace_all("\\(District\\)", "") %>% 
           str_replace_all("(Regional|Charter) School District", "") %>% 
           str_replace_all("Regional$", "") %>% 
           str_trim() %>% 
           str_to_lower())

### Assess status of cleaning
  
# Calculate matches
ma_sds_match <- ma_sds$distr_name_forcomp %in% ma_ed$distr_name_forcomp
# What percent match?
mean(ma_sds_match)
# Which don't match?
non_matches <- ma_sds$distr_name_forcomp[!ma_sds_match]
print(non_matches)

# Some code to interactively investigate
str_subset(ma_sds$distr_name_forcomp, paste(non_matches, collapse = "|"))
str_subset(unique(ma_ed$distr_name_forcomp), paste(non_matches, collapse = "|"))


```

```{r}
#| label: generate a mapping between tracts and school districts for aggregation

# First ensure that the poverty data and school districts have the same 
# coordinate reference system
st_crs(ma_pov) <- st_crs(ma_sds)

# Generate the intersection of tracts and school districts
# Note: this operation creates a row for every unique overlap of geography, as
# if cutting stained glass based on the overlap of multiple layers
tr_sd_intersect <- st_intersection(ma_pov, ma_sds)

# Calculate the size of overlap to identify small parts of tracts that do not
# merit maintaining
tr_sd_xwalk <- 
  tr_sd_intersect %>% 
  mutate(area = st_area(tr_sd_intersect)) %>% 
  mutate(pct_tract_in_sd = area / sum(area),
          .by = GEOID) %>% 
  filter(as.numeric(pct_tract_in_sd) > 0.1) %>% 
  # recalculate percentages
  mutate(pct_tract_in_sd = area / sum(area),
          .by = GEOID) %>% 
  select(GEOID, distr_name_forcomp, pct_tract_in_sd)

```

  