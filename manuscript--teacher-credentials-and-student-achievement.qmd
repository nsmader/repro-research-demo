---
title: "Teacher Experience and Pay, and Student Tested Achievement"
author: "Nick Mader (nsmader@gmail.com)"
format: docx
csl: apa-6th-edition.csl
bibliography: teacher_experience_citations.bib
editor: source
echo: false
warning: false
message: false
error: false
---

# Background

This project uses public, aggregate data from Massachusetts to demonstrate the use of open-source tools including:

* the [R programming language](https://www.r-project.org/) for reading, preparing, visualizing, and analyzing data; 
* [Quarto](https://quarto.org/) for formatting and generation of technical documents using principles of reproducible research; and
* [git](https://git-scm.com/), for version control.

All of the materials for producing this report, and for making use of version control in doing so, can be found on GitHub at the following link: https://github.com/nsmader/repro-research-demo.

# Literature

The education literature includes several rigorous studies of the impact of teacher experience on student achievement, including @huang_is_2009 and @ladd_returns_2017. This analysis is not one of them. Here, we explore district aggregate patterns in Massachusetts--which entails the strong possibility of [ecological fallacy](https://en.wikipedia.org/wiki/Ecological_fallacy)--but for the sake of demonstrating the use of the tools mentioned above, while relying on publicly accessible data.

# Data

```{r}
source("00-project-setup.R")
load("data/ma_ed.Rda")
load("data/geo_data.Rda")

ma_ed_pov <- 
  merge(ma_ed_formerge %>% select(-distr_name),
        ma_pov_distr,
        by = c("distr_name_forcomp")) %>% 
  rename(distr_name = distr_name_forcomp) %>% 
  mutate(pov_pct_10pp = pov_pct * 10)
```


```{r}
#| label: meta data on labels

renames <- 
  tribble(~field, ~label,
          "me_pct",      "% Meets/Exceeds Proficiency Standard",
            "e_pct",      "% Exceeds Proficiency Standard",
           "me_pct_ELA",      "% Meets/Exceeds -- ELA",
            "e_pct_ELA",      "% Exceeds -- ELA",
          "me_pct_MATH",      "% Meets/Exceeds -- Math",
           "e_pct_MATH",      "% Exceeds -- Math",
           "me_pct_SCI",      "% Meets/Exceeds -- Science",
            "e_pct_SCI",      "% Exceeds -- Science",
          "lic_pct",          "% Teachers Licensed",
          "exp_pct",          "% Teachers Experienced",
          "pov_pct",          "Poverty Rate",
          "stud_teach_ratio", "Student-to-Teacher Ratio",
          "avg_pay_10k",      "Average Pay ($10ks)")

rename_var <- function(x) {
  renames$label[match(x, renames$field)]
}
```


Data is drawn from the Massachusetts state Department of Education.

## District Characteristics

Univariate distribution plots show that percentages of students meeting or exceeding proficiency standards in English and Language Arts (ELA) and Mathematics, as well as the percent of teachers classified as experienced and average pay have wide distributions across the state of Massachusetts. There is a long left tail in the distribution of rates of teacher experience across districts, but there is notable variation between 75-100%.

```{r}
#| label: univariate distributions
ma_ed_pov %>% 
  filter(subj == "ELA") %>% 
  rename(me_pct_ELA = me_pct) %>% 
  pivot_longer(cols = -c(distr_name, distr_code, subj)) %>% 
  filter(name %in% c("me_pct_ELA", "avg_pay_10k", "exp_pct")) %>% 
  mutate(label = rename_var(name)) %>% 
  ggplot(aes(x = value,
             color = label)) +
    geom_density() +
    facet_wrap(~label,
               scales = "free") +
  scale_color_discrete(name = "") +
  labs(x = "", 
       y = "Proportion of districts with x-axis value") +
  theme_minimal() +
  theme(legend.position = "none",
        axis.text.y = element_blank())
```

Looking at bivariate distributions between the percent of students meeting/exceeding proficiency standards for different subjects and teacher experience shows strong positive relationships.


```{r}
#| label: bivariate test vs experience
ggplot(ma_ed,
       aes(x = exp_pct,
           y = me_pct)) +
  geom_point(alpha = 0.3) + 
  geom_smooth() + 
  facet_wrap(~ subj,
             ncol = 2) +
  labs(title = "District Rates of MCAS Proficiency by Teacher Experience",
       x = '% of teachers that are "experienced"',
       y = "% Meets/Exceeds",
       caption = 'Note: teachers are "experienced" if they are XYZ.') +
  scale_x_continuous(labels = percent) +
  scale_y_continuous(labels = percent) +
  theme(plot.title.position = "plot") +
  theme_minimal()
```

Note that districts vary widely by poverty rate. @fig-pov-maps respectively shows district poverty rates across the state (@fig-pov-maps-1) and with detail in the Boston area (@fig-pov-maps-2).

```{r}
#| label: fig-pov-maps
#| fig-cap: Poverty Rate for Massachusetts School Districts
#| fig-subcap: 
#|   - "State-Wide"
#|   - "Metro Boston"

make_map <- function(map_data) {
  ggplot(map_data,
         aes(fill = pov_pct)) +
    geom_sf(color = NA) +
    scale_fill_continuous(name = "Poverty Rate",
                          labels = percent) +
    theme_void()
}

ma_map <- 
  ma_sds %>% 
  merge(ma_pov_distr,
        by = "distr_name_forcomp") 

make_map(ma_map)
# Bounds for Boston were found manually using the bounding box finder:
#   http://bboxfinder.com/
make_map(ma_map %>% 
           st_crop(ymin =  42.201395,
                   ymax =  42.523061,
                   xmin = -71.371765,
                   xmax = -70.841675))

```

@tbl-stats-by-pov shows a selection of district characteristics, comparing districts that are above versus below the state-wide median poverty across districts.

```{r}
#| label: tbl-stats-by-pov
#| tbl-cap: "District Statistics for Low vs High Poverty Districts"

# See this reference for the `tbl_summary()` function in the `gtsummary` package:
#   https://www.danieldsjoberg.com/gtsummary/articles/tbl_summary.html

ma_ed_pov <- 
  ma_ed_pov %>% 
  mutate(median_pov = median(pov_pct),
         fPov_highlow = ifelse(pov_pct > median_pov, "Pov > Median", "Pov < Median") %>% factor())

ma_ed_pov %>% 
  filter(subj == "ELA") %>% 
  rename(me_pct_ela = me_pct) %>% 
  tbl_summary(include = c("me_pct_ela", "exp_pct", "avg_pay_10k", "stud_teach_ratio"),
              label = list(me_pct_ela ~ "% Meets/Exceeds -- ELA",
                           exp_pct ~ "% Experienced Teachers",
                           avg_pay_10k ~ "Average Teacher Pay ($1000s)",
                           stud_teach_ratio ~ "Student-to-Teacher Ratio"),
              by = fPov_highlow) %>% 
  # Note: for some reason, for this chunk to produce output that Quarto can
  # cross-references as "Table 1", this object needs to be output as a kable
  # table
  as_kable()

```


# Methods

To explore multivariate relationships, we make use of ordinary least squares, with the closed form captured in @eq-ols.

$$y_i = \alpha + \beta_1 exp_i + \beta_2pay_i + \mathbf{\beta}x_i + \epsilon_i$${#eq-ols}

# Results

```{r}
#| label: conduct regression analysis

vX <- c("exp_pct", "avg_pay_10k", "stud_teach_ratio", "pov_pct_10pp")
x_plus <- paste(vX, collapse = " + ")

# Collect regression output in list format
subjs <- c("ELA", "MATH", "SCI")
lRegs <- 
  lapply(subjs, 
         function(y) {
           lm(glue("me_pct ~ {x_plus}"), data = ma_ed_pov %>% filter(subj == y))
         }
  )
names(lRegs) <- subjs

```

@tbl-regs shows regression results for analysis of each student subject.

```{r}
#| label: tbl-regs
#| tbl-cap: "Estimated Coefficients by Subject"

# See this article for examples of using `tbl_regression()`: 
#   https://rpubs.com/muntasir_masum/tableoutput

# Establish function for formatting a single table
fmt_reg <- function(fit) {
  tbl_regression(fit,
                 estimate_fun = function(x) round(x, 3),
                 conf.int = FALSE,
                 label = list(exp_pct ~ "% Experienced Teachers",
                              avg_pay_10k ~ "Average Teacher Pay ($1000s)",
                              stud_teach_ratio ~ "Student-to-Teacher Ratio",
                              pov_pct_10pp ~ "Poverty Rate (10 pct pts)")) %>%
    bold_p() %>%
    modify_column_unhide(column = std.error)
}

# Apply this function to each regression
lReg_tbls <- lapply(lRegs, fmt_reg)

# Merge the regression tables
tbl_stack(
  tbls = lReg_tbls,
  group_header = subjs) %>% 
  modify_header(groupname_col = "Subject") %>% 
  # Note: for some reason, for this chunk to produce output that Quarto can
  # cross-references as "Table 1", this object needs to be output as a kable
  # table
  as_kable()
```


# Bibliography


::: {#refs}
:::